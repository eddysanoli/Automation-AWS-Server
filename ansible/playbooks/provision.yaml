# Target all hosts in the inventory
- hosts: "*"

  # Name of the playbook
  name: provision-minecraft-server

  # Make it so that Ansible can "escalate" to root
  # (i.e. run commands using sudo)
  become: true
  tasks:
    # ---------------------------------------------- #
    - name: Update Server Packages
      apt:
        update_cache: yes
        upgrade: yes

    # ============================================== #
    # MINECRAFT                                      #
    # ============================================== #

    - name: Add Java Repository
      apt_repository:
        repo: ppa:linuxuprising/java
        state: present

    - name: Install Java 16
      apt:
        name: oracle-java16-installer
        state: present

    # -------------------------------------------- #
    - name: Create the Root Minecraft Folder
      file:
        path: /home/ubuntu/minecraft
        state: directory
        mode: "0755"

    - name: Download the Latest Minecraft Server .jar
      get_url:
        url: https://piston-data.mojang.com/v1/objects/f69c284232d7c7580bd89a5a4931c3581eae1378/server.jar
        dest: /home/ubuntu/minecraft/server.jar
        mode: "0755"

    # -------------------------------------------- #

    - name: Copy Minecraft Worlds
      copy:
        src: "/opt/ansible/storage/minecraft/worlds"
        dest: "/home/ubuntu/minecraft"
        directory_mode: yes

    - name: Copy Minecraft Server Properties
      copy:
        src: "/opt/ansible/storage/minecraft/server.properties"
        dest: "/home/ubuntu/minecraft/server.properties"
        mode: "0644"

    # If we don't do this, the server will need to manually accept the EULA
    - name: Copy Minecraft EULA
      copy:
        src: "/opt/ansible/storage/minecraft/eula.txt"
        dest: "/home/ubuntu/minecraft/eula.txt"
        mode: "0644"

    - name: Copy Minecraft Server Icon
      copy:
        src: "/opt/ansible/storage/minecraft/server-icon.png"
        dest: "/home/ubuntu/minecraft/server-icon.png"
        mode: "0644"

    # ============================================== #
    # TERRARIA                                       #
    # ============================================== #

    - name: Create the Root Terraria Folder
      file:
        path: /home/ubuntu/terraria
        state: directory
        mode: "0755"

    - name: Install Required Packages
      apt:
        name:
          - unzip
        state: present

    # -------------------------------------------- #

    - name: Download the Latest Terraria Server .zip
      get_url:
        url: https://terraria.org/api/download/pc-dedicated-server/terraria-server-1447.zip
        dest: /home/ubuntu/terraria/terraria-server.zip
        mode: "0755"

    - name: Unzip the Terraria Server .zip
      unarchive:
        src: /home/ubuntu/terraria/terraria-server.zip
        dest: /home/ubuntu/terraria
        remote_src: yes

    - name: Remove the Terraria Server .zip
      file:
        path: /home/ubuntu/terraria/terraria-server.zip
        state: absent

    # -------------------------------------------- #

    - name: Add Executable Permissions to the Server Binary
      file:
        path: /home/ubuntu/terraria/1447/Linux/TerrariaServer.bin.x86_64
        mode: "0755"

    - name: Copy the Terraria Worlds
      copy:
        src: "/opt/ansible/storage/terraria/worlds"
        dest: "~/.local/share/Terraria/Worlds/"
        directory_mode: yes
